<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Qu·∫£n l√Ω ƒëi·ªÉm tr√™n b·∫£n ƒë·ªì</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- Leaflet Routing Machine -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<!-- Lottie -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js" referrerpolicy="no-referrer"></script>

<style>
  :root{
  --bg:#f6f8fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --primary:#2563eb;
  --border:#e5e7eb; --radius:14px;
}
*{box-sizing:border-box}
body{margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink);}
header{padding:18px 20px 8px;}
h1{margin:0 0 6px; font-size:22px;}
p.sub{margin:0; color:var(--muted); font-size:13px}

/* Toolbar */
.toolbar{
  display:grid; grid-template-columns: 1fr auto auto auto auto auto auto; gap:10px; align-items:center;
  background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 12px; margin:10px 20px 0;
}
@media (max-width:1100px){ .toolbar{ grid-template-columns: 1fr; } }
.toolbar .input, .toolbar select{
  padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; outline:none;
}
.toolbar .btn{
  padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; font-weight:600;
}
.toolbar .btn-primary{ background:var(--primary); color:#fff; border-color:var(--primary); }
.toolbar .seg{display:flex; gap:6px; flex-wrap:wrap}
.seg .toggle{padding:8px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer; background:#fff; font-weight:600;}
.seg .toggle.active{background:#eef2ff; border-color:#c7d2fe; color:#1e3a8a;}
.pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; border:1px solid var(--border); font-size:12px; margin-left:6px;}

/* ======= Layout ======= */
#top-row{
  display:grid;
  grid-template-columns: minmax(340px, 1fr) minmax(520px, 1.4fr) minmax(320px, 0.9fr);
  gap:16px; align-items:start; padding:10px 20px 12px;
}
@media (max-width: 1200px){ #top-row{ grid-template-columns: 1fr; } }

/* Viewer mode: b·ªè c·ªôt tr√°i, map tr√†n qua */
body[data-viewer="1"] #top-row{
  grid-template-columns: minmax(520px, 1fr) minmax(320px, 0.9fr);
}
body[data-viewer="1"] .left{ display:none !important; }   /* ·∫®n ho√†n to√†n form khi l√† ng∆∞·ªùi d√πng */

/* Map */
#map{
  width:100%; aspect-ratio:1/1; height:auto; min-height:420px;
  border-radius:var(--radius); background:#e8f0fe; border:1px solid transparent;
  box-shadow:0 10px 30px rgba(23,26,31,.16); position:relative;
}
#map::after {
  content: ""; position: absolute; inset: -1px; padding: 1px; border-radius: inherit; pointer-events: none;
  background: linear-gradient(135deg, #4f46e5, #06b6d4);
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor;
  mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); mask-composite: exclude;
}

/* Cards & Forms */
.tabs{display:flex; gap:10px; margin:14px 0;}
.tab-btn{ padding:10px 14px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; font-weight:600;}
.tab-btn.active{background:var(--primary); color:#fff; border-color:var(--primary);}
.grid{display:grid; grid-template-columns:1fr; gap:16px;}
.card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.04); overflow:hidden;}
.card h3{margin:0; padding:14px 16px; border-bottom:1px solid var(--border); background:#fafafa;}
.card .body{padding:14px 16px;}
.row{display:flex; gap:12px; align-items:center; margin:8px 0;}
.row label{width:130px; font-weight:600; color:#374151;}
.row input[type="text"], .row select, .row textarea{ flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none; background:#fff; }
.row textarea{min-height:70px; resize:vertical;}
.actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;}
.btn-primary{background:var(--primary); color:#fff; border-color:var(--primary);}
.btn-danger{background:#ef4444; color:#fff; border-color:#ef4444;}
.btn-ghost{background:#fff;}
.btn:active{transform:translateY(1px)}
.thumb{width:180px; height:120px; border-radius:10px; object-fit:cover; border:1px solid var(--border); background:#f3f4f6;}
.thumb-wrap{display:flex; align-items:center; gap:12px;}
.panel{display:none;} .panel.active{display:block;}

/* Detail (c·ªôt ph·∫£i) */
.detail .head{display:flex; align-items:center; gap:10px; padding:12px 14px; border-bottom:1px solid var(--border); background:#fafafa;}
.tag{padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; color:#fff;}
.tag.bank{background:#2563eb;} .tag.branch{background:#10b981;} .tag.atm{background:#f59e0b;}
.detail .body{padding:14px; display:flex; gap:16px; flex-wrap:wrap;}
.detail img.big{width:100%; height:auto; max-height:460px; object-fit:cover; border-radius:12px; border:1px solid var(--border); background:#f3f4f6;}
.kv{min-width:260px;} .kv .row{margin:6px 0;} .kv .k{font-weight:700; margin-right:6px;}
#detail-card{ position:sticky; top:12px; }

/* Results */
#results{ margin:10px 20px 0; display:none; position:relative; }
#results .section{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 12px; margin-top:8px; }
#results h4{ margin:0 0 6px; font-size:14px; color:#111827;}
#results .close{ position:absolute; right:14px; top:6px; border:1px solid var(--border); background:#fff; border-radius:999px; padding:4px 8px; cursor:pointer; }
.list{display:grid; gap:6px;}
.item{padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer;}
.item:hover{background:#f9fafb;}
.item .sub{font-size:12px; color:#6b7280;}
.dist{font-size:12px; color:#1f2937; font-weight:700; margin-left:8px;}

/* Modal Stats ‚Äî LU√îN n·ªïi tr√™n map */
.modal{
  position:fixed; inset:0; display:none; place-items:center;
  background:rgba(17,24,39,.35);
  z-index:3000;                    /* ‚Üë tƒÉng cao ƒë·ªÉ kh√¥ng bao gi·ªù b·ªã map ƒë√® */
}
.modal .box{width:min(1100px, 96vw); max-height:90vh; overflow:auto; background:#fff; border-radius:14px; border:1px solid var(--border); box-shadow:0 20px 60px rgba(0,0,0,.2);}
.modal header{display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border);}
.tabs2{display:flex; gap:8px; padding:10px 12px;}
.tabs2 .btn{padding:8px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; font-weight:600;}
.tabs2 .btn.active{background:#eef2ff; border-color:#c7d2fe; color:#1e3a8a;}
.table-wrap{padding:0 12px 16px;}
table{width:100%; border-collapse:collapse; font-size:14px;}
th, td{border-bottom:1px solid var(--border); padding:8px 10px; text-align:left;}
tbody tr{cursor:pointer;} tbody tr:hover{background:#f9fafb;}

/* Khi m·ªü modal: m·ªù n·ªÅn + kho√° click map/control */
body.is-modal-open #top-row,
body.is-modal-open .toolbar{ filter: blur(1px) brightness(.95); }
body.is-modal-open .gm-style,
body.is-modal-open .gm-style *{ pointer-events:none !important; } /* kho√° Google controls */
body.is-modal-open .modal,
body.is-modal-open .modal *{ pointer-events:auto !important; }    /* nh∆∞ng v·∫´n cho modal t∆∞∆°ng t√°c */

/* Lottie overlay */
#lottie-overlay{ position:fixed; inset:0; display:none; place-items:center; background:rgba(15,23,42,.32); z-index:4000; }
#lottie-overlay.show{ display:grid; }
#lottie-box{ width:min(260px,60vw); height:min(260px,60vw); }
#lottie-overlay .hint{
  margin-top:8px; font-weight:700; color:#111827; background:#fff;
  padding:8px 12px; border-radius:999px; border:1px solid var(--border);
  box-shadow:0 10px 30px rgba(0,0,0,.12); text-align:center;
}

/* PRO THEME */
html[data-mode="pro"]{
  --bg:#0b0f1a; --card:#0f172a; --ink:#e5e7eb; --muted:#9ca3af; --primary:#8b5cf6; --border:#1f2937;
}
html[data-mode="pro"] body{
  background:
    radial-gradient(1200px 800px at 10% -10%, rgba(139,92,246,.15), transparent),
    radial-gradient(1100px 700px at 90% 110%, rgba(14,165,233,.12), transparent),
    var(--bg);
  color:var(--ink);
}
html[data-mode="pro"] .toolbar,
html[data-mode="pro"] .card,
html[data-mode="pro"] .tab-btn,
html[data-mode="pro"] .tabs2 .btn,
html[data-mode="pro"] .item,
html[data-mode="pro"] .modal .box{
  background:rgba(15,23,42,.6) !important;
  backdrop-filter: blur(8px);
  border-color:var(--border) !important;
  color:var(--ink);
}
html[data-mode="pro"] .card h3,
html[data-mode="pro"] .detail .head{ background:rgba(2,6,23,.6); border-color:var(--border); }
html[data-mode="pro"] .pill{ background:rgba(2,6,23,.6); border-color:var(--border); color:var(--ink); }
html[data-mode="pro"] #map::after{ background: conic-gradient(from 0deg, #8b5cf6, #06b6d4, #8b5cf6); }

.map-col{ position:relative; }

/* Xe ch·∫°y ven khung map */
#map-car{
  position:absolute; z-index:5; pointer-events:none; width:26px; height:26px;
  top:var(--pad,10px); left:var(--pad,10px); display:grid; place-items:center;
  animation:drive-around 12s linear infinite; filter: drop-shadow(0 2px 4px rgba(0,0,0,.25)); will-change: transform;
}
#map-car::before{ content:"üöó"; font-size:22px; line-height:1; }
@keyframes drive-around{
  0%{ transform: translate(0,0) rotate(0deg); }
  25%{ transform: translate(var(--w,300px), 0) rotate(90deg); }
  50%{ transform: translate(var(--w,300px), var(--h,300px)) rotate(180deg); }
  75%{ transform: translate(0, var(--h,300px)) rotate(270deg); }
  100%{ transform: translate(0,0) rotate(360deg); }
}
#btn-pro-mode{ border-color:#c7d2fe; }
html[data-mode="pro"] #btn-pro-mode{ border-color:#8b5cf6; box-shadow:0 0 0 2px rgba(139,92,246,.15) inset; }

/* Icon marker (cho Advanced Marker ho·∫∑c legend) */
.pin{ width:28px; height:28px; border-radius:50%; display:grid; place-items:center; font-size:16px; color:#fff; border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,.25); }
.pin-bank{ background:#2563eb; }
.pin-branch{ background:#10b981; }
.pin-atm{ background:#f59e0b; }

</style>
</head>

<!-- viewer: 1 n·∫øu kh√¥ng ph·∫£i admin -->
<body data-viewer="{% if not request.user.is_superuser %}1{% endif %}">
  <header>
    <h1>Qu·∫£n l√Ω ƒëi·ªÉm tr√™n b·∫£n ƒë·ªì</h1>
    <p class="sub">T√¨m ki·∫øm chung cho Ng√¢n h√†ng / Chi nh√°nh / ATM. B·∫≠t v·ªã tr√≠ ƒë·ªÉ xem c√°c ƒëi·ªÉm g·∫ßn nh·∫•t. Th·ªëng k√™ to√†n b·ªô d·ªØ li·ªáu d·∫°ng b·∫£ng, click ƒë·ªÉ pan t·ªõi ƒëi·ªÉm.</p>
  </header>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <input id="q" class="input" placeholder="T√¨m m√£ / t√™n / ƒë·ªãa ch·ªâ‚Ä¶ (NH, CN, ATM)"/>
    <div class="seg" title="B·∫≠t/t·∫Øt l·ªõp hi·ªÉn th·ªã">
      <button class="toggle active" id="show-banks">Ng√¢n h√†ng</button>
      <button class="toggle active" id="show-branches">Chi nh√°nh</button>
      <button class="toggle active" id="show-atms">ATM</button>
    </div>
    <button class="btn" id="btn-my-location" title="B·∫≠t v·ªã tr√≠ c·ªßa t√¥i">üìç V·ªã tr√≠ c·ªßa t√¥i</button>
    <div class="seg">
      <button class="btn" id="btn-nearest-atm" title="ATM g·∫ßn t√¥i nh·∫•t">üéØ ATM g·∫ßn nh·∫•t</button>
      <button class="btn" id="btn-nearest-branch" title="Chi nh√°nh g·∫ßn t√¥i nh·∫•t">üéØ Chi nh√°nh g·∫ßn nh·∫•t</button>
      <button class="btn" id="btn-nearest-bank" title="Ng√¢n h√†ng g·∫ßn t√¥i nh·∫•t">üéØ Ng√¢n h√†ng g·∫ßn nh·∫•t</button>
    </div>
    <button class="btn" id="btn-pro-mode" title="Giao di·ªán chuy√™n nghi·ªáp">‚ö° Ch·∫ø ƒë·ªô Pro</button>
    <button class="btn" id="btn-reset-ui" title="Xo√° b·ªô l·ªçc, k·∫øt qu·∫£, route">üßπ Reset</button>

    <!-- ƒêƒÉng xu·∫•t (POST) -->
    <form id="logout-form" method="post" action="{% url 'logout' %}" style="margin:0">
      {% csrf_token %}
      <button class="btn" id="btn-logout" title="ƒêƒÉng xu·∫•t">‚Ü©Ô∏é ƒêƒÉng xu·∫•t</button>
    </form>

    {% if request.user.is_superuser %}
      <button class="btn btn-primary" id="btn-stats">üìä Th·ªëng k√™</button>
      <button class="btn" id="btn-permissions">üõ°Ô∏è Ph√¢n quy·ªÅn</button>
    {% endif %}
  </div>

  <!-- RESULTS -->
  <div id="results"></div>

  <!-- ======= H√ÄNG TR√äN ======= -->
  <section id="top-row">
    <!-- C·ªòT TR√ÅI: ch·ªâ hi·ªán cho admin -->
    {% if request.user.is_superuser %}
    <div class="left">
      <div class="tabs">
        <button class="tab-btn active" data-tab="bank">Th√™m Ng√¢n h√†ng</button>
        <button class="tab-btn"        data-tab="branch">Th√™m Chi nh√°nh</button>
        <button class="tab-btn"        data-tab="atm">Th√™m ATM</button>
      </div>

      <div class="grid">
        <!-- BANK -->
        <div class="card panel active" id="panel-bank">
          <h3>Ng√¢n h√†ng</h3>
          <button class="btn" id="toggle-bank-form" title="ƒê√≥ng/M·ªü Form">‚è∫</button>
          <div class="body">
            <form id="form-save-bank" method="POST">
              {% csrf_token %}
              <input type="hidden" id="bank_id" name="bank_id"/>
              <div class="row"><label>M√£ ng√¢n h√†ng</label><input type="text" id="bank_code" name="code" placeholder="VD: VCB"/></div>
              <div class="row"><label>T√™n ng√¢n h√†ng</label><input type="text" id="bank_name" name="name" placeholder="Vietcombank"/></div>
              <div class="row"><label>ƒê·ªãa ch·ªâ</label><input type="text" id="bank_address" name="address"/></div>
              <div class="row"><label>SƒêT</label><input type="text" id="bank_phone" name="phone"/></div>
              <div class="row">
                <label>H√¨nh ·∫£nh (URL)</label>
                <div class="thumb-wrap">
                  <input type="text" id="bank_image" name="image" placeholder="https://.../logo.png"/>
                  <img id="bank_preview" class="thumb" alt="Preview"/>
                </div>
              </div>
              <div class="row"><label>Latitude</label><input type="text" id="bank_latitude" name="latitude" readonly/></div>
              <div class="row"><label>Longitude</label><input type="text" id="bank_longitude" name="longitude" readonly/></div>
              <div class="row"><label>Ng√†y t·∫°o</label><input type="text" id="bank_created" readonly/></div>
              <div class="row"><label>Ng√†y c·∫≠p nh·∫≠t</label><input type="text" id="bank_updated" readonly/></div>
              <div class="actions">
                <button type="submit" class="btn btn-primary">L∆∞u Ng√¢n h√†ng</button>
                <button type="button" class="btn btn-danger" id="btn-delete-bank">Xo√°</button>
                <button type="button" class="btn btn-ghost" id="btn-reset-bank">Reset</button>
              </div>
            </form>
          </div>
        </div>

        <!-- BRANCH -->
        <div class="card panel" id="panel-branch">
          <h3>Chi nh√°nh</h3>
          <button class="btn" id="toggle-branch-form" title="ƒê√≥ng/M·ªü Form">‚è∫</button>
          <div class="body">
            <form id="form-save-branch" method="POST">
              {% csrf_token %}
              <input type="hidden" id="branch_id" name="branch_id"/>
              <div class="row"><label>Ng√¢n h√†ng</label><select id="branch_bank" name="bank"></select></div>
              <div class="row"><label>M√£ chi nh√°nh</label><input type="text" id="branch_code" name="code" placeholder="VD: HN-01"/></div>
              <div class="row"><label>T√™n chi nh√°nh</label><input type="text" id="branch_name" name="name"/></div>
              <div class="row"><label>ƒê·ªãa ch·ªâ</label><input type="text" id="branch_address" name="address"/></div>
              <div class="row"><label>SƒêT</label><input type="text" id="branch_phone" name="phone"/></div>
              <div class="row">
                <label>H√¨nh ·∫£nh (URL)</label>
                <div class="thumb-wrap">
                  <input type="text" id="branch_image" name="image" placeholder="https://.../photo.jpg"/>
                  <img id="branch_preview" class="thumb" alt="Preview"/>
                </div>
              </div>
              <div class="row"><label>Latitude</label><input type="text" id="branch_latitude" name="latitude" readonly/></div>
              <div class="row"><label>Longitude</label><input type="text" id="branch_longitude" name="longitude" readonly/></div>
              <div class="row"><label>Ng√†y t·∫°o</label><input type="text" id="branch_created" readonly/></div>
              <div class="row"><label>Ng√†y c·∫≠p nh·∫≠t</label><input type="text" id="branch_updated" readonly/></div>
              <div class="actions">
                <button type="submit" class="btn btn-primary">L∆∞u Chi nh√°nh</button>
                <button type="button" class="btn btn-danger" id="btn-delete-branch">Xo√°</button>
                <button type="button" class="btn btn-ghost" id="btn-reset-branch">Reset</button>
              </div>
            </form>
          </div>
        </div>

        <!-- ATM -->
        <div class="card panel" id="panel-atm">
          <h3>ATM</h3>
          <button class="btn" id="toggle-atm-form" title="ƒê√≥ng/M·ªü Form">‚è∫</button>
          <div class="body">
            <form id="form-save-atm" method="POST">
              {% csrf_token %}
              <input type="hidden" id="atm_id" name="atm_id"/>
              <div class="row"><label>Chi nh√°nh</label><select id="branch" name="branch"></select></div>
              <div class="row"><label>ATM Code</label><input type="text" id="code" name="code" placeholder="VD: ATM-HN-0001"/></div>
              <div class="row"><label>Status</label>
                <select id="atm_status" name="status">
                  <option value="active">Ho·∫°t ƒë·ªông</option>
                  <option value="maintenance">B·∫£o tr√¨</option>
                  <option value="offline">Offline</option>
                </select>
              </div>
              <div class="row"><label>ƒê·ªãa ch·ªâ</label><textarea id="address" name="address"></textarea></div>
              <div class="row">
                <label>H√¨nh ·∫£nh (URL)</label>
                <div class="thumb-wrap">
                  <input type="text" id="atm_image" name="image" placeholder="https://.../atm.jpg"/>
                  <img id="atm_preview" class="thumb" alt="Preview"/>
                </div>
              </div>
              <div class="row"><label>Latitude</label><input type="text" id="latitude" name="latitude" readonly/></div>
              <div class="row"><label>Longitude</label><input type="text" id="longitude" name="longitude" readonly/></div>
              <div class="row"><label>Ng√†y t·∫°o</label><input type="text" id="atm_created" readonly/></div>
              <div class="row"><label>Ng√†y c·∫≠p nh·∫≠t</label><input type="text" id="atm_updated" readonly/></div>
              <div class="actions">
                <button type="submit" class="btn btn-primary">L∆∞u ATM</button>
                <button type="button" class="btn btn-danger" id="btn-delete-atm">Xo√°</button>
                <button type="button" class="btn btn-ghost" id="btn-reset-atm">Reset</button>
              </div>
            </form>
          </div>
        </div>
      </div><!-- /grid -->
    </div>
    {% endif %}

    <!-- C·ªòT GI·ªÆA: MAP -->
    <div class="map-col">
      <div id="map"></div>
      <div id="map-car" aria-hidden="true"></div>
    </div>

    <!-- C·ªòT PH·∫¢I: CHI TI·∫æT -->
    <aside class="detail right">
      <div id="detail-card" class="card" style="display:none;">
        <div class="head">
          <span id="detail-tag" class="tag">TYPE</span>
          <div>
            <div id="detail-title" style="font-weight:800;"></div>
            <div id="detail-sub" class="muted"></div>
          </div>
        </div>
        <div class="body">
          <img id="detail-img" class="big" alt="H√¨nh"/>
          <div class="kv" id="detail-kv"></div>
        </div>
      </div>
    </aside>
  </section>

  <!-- Modal Th·ªëng k√™ -->
  {% if request.user.is_superuser %}
  <div class="modal" id="stats-modal" aria-hidden="true">
    <div class="box">
      <header>
        <strong>Th·ªëng k√™ CSDL</strong>
        <button class="btn" id="stats-close">ƒê√≥ng</button>
      </header>
      <div class="tabs2">
        <button class="btn active" data-tab="stats-banks">Ng√¢n h√†ng</button>
        <button class="btn" data-tab="stats-branches">Chi nh√°nh</button>
        <button class="btn" data-tab="stats-atms">ATM</button>
      </div>
      <div class="table-wrap">
        <div id="stats-banks" class="panel active">
          <table id="tbl-banks">
            <thead><tr><th>M√£</th><th>T√™n ng√¢n h√†ng</th><th>S·ªë chi nh√°nh</th><th>S·ªë ATM</th><th>ƒê·ªãa ch·ªâ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="stats-branches" class="panel">
          <table id="tbl-branches">
            <thead><tr><th>Ng√¢n h√†ng</th><th>M√£ CN</th><th>T√™n chi nh√°nh</th><th>S·ªë ATM</th><th>ƒê·ªãa ch·ªâ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="stats-atms" class="panel">
          <table id="tbl-atms">
            <thead><tr><th>M√£ ATM</th><th>Ng√¢n h√†ng</th><th>Chi nh√°nh</th><th>Tr·∫°ng th√°i</th><th>ƒê·ªãa ch·ªâ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Lottie overlay -->
  <div id="lottie-overlay" aria-hidden="true">
    <div>
      <div id="lottie-box"></div>
      <div class="hint">ƒêang x·ª≠ l√Ω‚Ä¶</div>
    </div>
  </div>

  <!-- Data t·ª´ view -->
  <script>
    const BANKS     = {{ banks_json|safe }};
    const BRANCHES  = {{ branches_json|safe }};
    const ATMS_INIT = {{ atms_json|safe }};

    function getCSRFToken(){
      const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
      if (el && el.value) return el.value;
      const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
      return m ? decodeURIComponent(m[1]) : '';
    }
    const pickImage = (d) => d.image_url || d.image || "";
    const esc = (s) => (s||"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    function localTimeStr(ts, fallback=""){ if(ts===null||ts===undefined) return fallback||""; const d=new Date(ts*1000); return d.toLocaleString('vi-VN',{hour12:false}); }
  </script>

  <script>
  let map, routingControl, clickMarker=null;
  let bankMarkers=[], branchMarkers=[], atmMarkers=[];
  let atms=[...ATMS_INIT];

  let showBanks=true, showBranches=true, showATMs=true;
  let qText="";
  let meMarker=null, myPos=null, geoWatchId=null;
  let hoverTimer=null;

  let filterBankIdForATMs = null;
  let filterBankIdForBranches = null;

  let baseLight, baseDark;

  /* ===== Admin helper =====

  Ki·ªÉm tra xem ng∆∞·ªùi d√πng c√≥ ph·∫£i l√† admin kh√¥ng (d·ª±a tr√™n s·ª± hi·ªán di·ªán c·ªßa form "form-save-bank"). */

  function isAdmin(){
    return !!document.getElementById("form-save-bank"); // c√≥ form => admin
  }

  /* Tabs
  Thay ƒë·ªïi tab ƒëang ƒë∆∞·ª£c k√≠ch ho·∫°t v√† hi·ªÉn th·ªã n·ªôi dung t∆∞∆°ng ·ª©ng.
  */

  function setActiveTab(key){
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.toggle("active", b.dataset.tab===key));
    document.querySelectorAll(".panel").forEach(p=>p.classList.toggle("active", p.id===`panel-${key}`));
    location.hash="#"+key;
  }
  document.addEventListener("click", (e)=>{
    const t=e.target.closest(".tab-btn"); if(!t) return;
    setActiveTab(t.dataset.tab);
  });

  /* Fill selects
  ƒêi·ªÅn th√¥ng tin ng√¢n h√†ng v√†o select (dropdown) theo ID c·ªßa n√≥.
  */
  function fillBanks(selId){
    const sel=document.getElementById(selId); if(!sel) return; sel.innerHTML="";
    BANKS.forEach(b=>{ const opt=document.createElement("option"); opt.value=b.id; opt.textContent=`${b.code} - ${b.name}`; sel.appendChild(opt); });
  }
  /*ƒêi·ªÅn th√¥ng tin chi nh√°nh v√†o select (dropdown) theo ID c·ªßa n√≥.*/
  function fillBranches(selId){
    const sel=document.getElementById(selId); if(!sel) return; sel.innerHTML="";
    BRANCHES.forEach(br=>{ const opt=document.createElement("option"); opt.value=br.id; opt.textContent=`${br["bank__name"]||""} - ${br.name}`; sel.appendChild(opt); });
  }

  /* Preview ·∫£nh
  * Li√™n k·∫øt input URL h√¨nh ·∫£nh v·ªõi ph·∫ßn preview ·∫£nh.
  */
  function bindPreview(inputId, imgId){
    const input=document.getElementById(inputId), img=document.getElementById(imgId);
    if(!input || !img) return;
    const apply=()=>{ const v=input.value.trim(); img.src=v? v : ""; }; input.addEventListener("input", apply); apply();
  }

  /* Counts 
  * ƒê·∫øm s·ªë l∆∞·ª£ng chi nh√°nh c·ªßa m·ªôt ng√¢n h√†ng,atm,chi nh√°nh
  */
  function countBranchesOfBank(bankId){ return BRANCHES.filter(br=>br.bank_id===bankId).length; }
  function countATMsOfBank(bankId){ return atms.filter(a=> (a.branch__bank_id===bankId || a.bank_id===bankId)).length; }
  function countATMsOfBranch(branchId){ return atms.filter(a=> (a.branch_id===branchId || a.branch===branchId)).length; }

  /* Info / Detail
  * T·∫°o HTML th√¥ng tin chi ti·∫øt cho Ng√¢n h√†ng, Chi nh√°nh ho·∫∑c ATM.
   */
  function infoHTML(type, d){
    const title = type==="bank"
      ? `${esc(d.code||"")} - ${esc(d.name||"")}`
      : type==="branch"
        ? `${esc(d["bank__name"]||"")} - ${esc(d.name||"")}`
        : `${esc(d.code||"ATM")}`;

    const rows=[];
    if(type==="bank"){
      rows.push(`<div><b>T√™n ng√¢n h√†ng:</b> ${esc(d.name||"")}</div>`);
      rows.push(`<div><b>M√£ NH:</b> ${esc(d.code||"")}</div>`);
      if(d.phone) rows.push(`<div><b>SƒêT:</b> ${esc(d.phone)}</div>`);
    }else if(type==="branch"){
      rows.push(`<div><b>Ng√¢n h√†ng:</b> ${esc(d["bank__name"]||"")}</div>`);
      rows.push(`<div><b>M√£ CN:</b> ${esc(d.code||"")}</div>`);
    }else{
      rows.push(`<div><b>M√£ ATM:</b> ${esc(d.code||"‚Äî")}</div>`);
      rows.push(`<div><b>Tr·∫°ng th√°i:</b> ${esc(d.status||"")}</div>`);
      if(d["branch__name"]) rows.push(`<div><b>Chi nh√°nh:</b> ${esc(d["branch__name"])}</div>`);
      if(d["branch__bank__name"]) rows.push(`<div><b>Ng√¢n h√†ng:</b> ${esc(d["branch__bank__name"])}</div>`);
    }
    rows.push(`<div><b>ƒê·ªãa ch·ªâ:</b> ${esc(d.address||"")}</div>`);
    rows.push(`<div><b>Lat/Lng:</b> ${d.latitude ?? ""} , ${d.longitude ?? ""}</div>`);
    rows.push(`<div><b>Ng√†y t·∫°o:</b> ${localTimeStr(d.created_ts, esc(d.created_at||""))} ¬∑ <b>C·∫≠p nh·∫≠t:</b> ${localTimeStr(d.updated_ts, esc(d.updated_at||""))}</div>`);

    const img = pickImage(d);
    const bankId = type==="bank" ? d.id : (type==="branch" ? d.bank_id : (d.branch__bank_id ?? d.bank_id));
    const destLat = d.latitude ?? d.lat, destLng = d.longitude ?? d.lng;

    return `<div style="max-width:360px;">
      ${img? `<img src="${esc(img)}" style="width:320px;height:200px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;margin-bottom:8px;">` : ""}
      <div style="font-weight:800;margin-bottom:4px;">${title}</div>
      <div style="font-size:12px;line-height:1.5;color:#374151;">${rows.join("")}</div>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
        ${type!=="atm" ? `<button class="btn btn-primary" data-act="view-atm" data-bank-id="${bankId}">Xem ATM</button>` : ``}
        ${type!=="atm" ? `<button class="btn btn-primary" data-act="view-branch" data-bank-id="${bankId}">Xem Chi nh√°nh</button>` : ``}
        <button class="btn" data-act="route" data-lat="${destLat}" data-lng="${destLng}">Ch·ªâ ƒë∆∞·ªùng</button>
      </div>
    </div>`;
  }

  /*
  * Hi·ªÉn th·ªã chi ti·∫øt th√¥ng tin c·ªßa Ng√¢n h√†ng, Chi nh√°nh ho·∫∑c ATM.
  */
  function setDetail(type, d){
    const box=document.getElementById('detail-card');
    box.style.display="block";
    const tag=document.getElementById('detail-tag');
    tag.className="tag "+(type==="bank"?"bank":type==="branch"?"branch":"atm");
    tag.textContent=type.toUpperCase();

    const titleEl=document.getElementById('detail-title');
    const subEl=document.getElementById('detail-sub');
    const imgEl=document.getElementById('detail-img');
    const kvEl=document.getElementById('detail-kv');

    if(type==="bank"){ titleEl.textContent=`${d.code||""} - ${d.name||""}`; subEl.textContent=d.address||""; }
    else if(type==="branch"){ titleEl.textContent=`${d["bank__name"]||""} - ${d.name||""}`; subEl.textContent=d.address||""; }
    else { titleEl.textContent=d.code||"ATM"; subEl.textContent=(d.address||"")+(d.status?` ¬∑ ${d.status}`:""); }
    imgEl.src=pickImage(d);

    const lines=[];
    if(type!=="bank" && d["bank__name"]) lines.push(`<div class="row"><span class="k">Ng√¢n h√†ng:</span><span>${esc(d["bank__name"])}</span></div>`);
    if(type==="atm" && d["branch__name"]) lines.push(`<div class="row"><span class="k">Chi nh√°nh:</span><span>${esc(d["branch__name"])}</span></div>`);
    if(type==="bank"){
      lines.push(`<div class="row"><span class="k">T√™n NH:</span><span>${esc(d.name||"")}</span></div>`);
      lines.push(`<div class="row"><span class="k">M√£ NH:</span><span>${esc(d.code||"")}</span></div>`);
    }
    if(type==="branch"){ lines.push(`<div class="row"><span class="k">M√£ CN:</span><span>${esc(d.code||"")}</span></div>`); }
    if(type==="atm"){
      lines.push(`<div class="row"><span class="k">M√£ ATM:</span><span>${esc(d.code||"‚Äî")}</span></div>`);
      lines.push(`<div class="row"><span class="k">Tr·∫°ng th√°i:</span><span>${esc(d.status||"")}</span></div>`);
    }
    if(type!=="atm" && d.phone) lines.push(`<div class="row"><span class="k">SƒêT:</span><span>${esc(d.phone)}</span></div>`);
    lines.push(`<div class="row"><span class="k">ƒê·ªãa ch·ªâ:</span><span>${esc(d.address||"")}</span></div>`);
    lines.push(`<div class="row"><span class="k">Lat/Lng:</span><span>${d.latitude ?? ""} , ${d.longitude ?? ""}</span></div>`);
    lines.push(`<div class="row"><span class="k">Ng√†y t·∫°o:</span><span>${localTimeStr(d.created_ts, esc(d.created_at||""))}</span></div>`);
    lines.push(`<div class="row"><span class="k">C·∫≠p nh·∫≠t:</span><span>${localTimeStr(d.updated_ts, esc(d.updated_at||""))}</span></div>`);
    kvEl.innerHTML=lines.join("");
  }

  /* ===== ƒê·ªî FORM (ADMIN) =====
  * ƒêi·ªÅn th√¥ng tin v√†o form "Ng√¢n h√†ng""Chi nh√°nh" ""(admin).
  */
  function fillBankForm(b){
    const f = document.getElementById("form-save-bank"); if(!f) return;
    setActiveTab("bank");
    document.getElementById("bank_id").value        = b.id ?? "";
    document.getElementById("bank_code").value      = b.code ?? "";
    document.getElementById("bank_name").value      = b.name ?? "";
    document.getElementById("bank_address").value   = b.address ?? "";
    document.getElementById("bank_phone").value     = b.phone ?? "";
    document.getElementById("bank_image").value     = b.image ?? "";
    document.getElementById("bank_preview").src     = pickImage(b);
    document.getElementById("bank_latitude").value  = b.latitude ?? "";
    document.getElementById("bank_longitude").value = b.longitude ?? "";
    document.getElementById("bank_created").value   = localTimeStr(b.created_ts, b.created_at||"");
    document.getElementById("bank_updated").value   = localTimeStr(b.updated_ts, b.updated_at||"");
  }
  function fillBranchForm(br){
    const f = document.getElementById("form-save-branch"); if(!f) return;
    setActiveTab("branch");
    document.getElementById("branch_id").value        = br.id ?? "";
    document.getElementById("branch_code").value      = br.code ?? "";
    document.getElementById("branch_name").value      = br.name ?? "";
    document.getElementById("branch_address").value   = br.address ?? "";
    document.getElementById("branch_phone").value     = br.phone ?? "";
    document.getElementById("branch_image").value     = br.image ?? "";
    document.getElementById("branch_preview").src     = pickImage(br);
    document.getElementById("branch_latitude").value  = br.latitude ?? "";
    document.getElementById("branch_longitude").value = br.longitude ?? "";
    if (document.getElementById("branch_bank")) document.getElementById("branch_bank").value = br.bank_id ?? br.bank ?? "";
    document.getElementById("branch_created").value   = localTimeStr(br.created_ts, br.created_at||"");
    document.getElementById("branch_updated").value   = localTimeStr(br.updated_ts, br.updated_at||"");
  }
  function fillATMForm(a){
    const f = document.getElementById("form-save-atm"); if(!f) return;
    setActiveTab("atm");
    document.getElementById("atm_id").value        = a.id ?? "";
    if (document.getElementById("branch")) document.getElementById("branch").value = a.branch_id ?? a.branch ?? "";
    document.getElementById("code").value          = a.code ?? "";
    // chu·∫©n ho√° tr·∫°ng th√°i
    const raw = (a.status ?? "active").toString().trim().toLowerCase();
    const STATUS_MAP = { "active":"active","ho·∫°t ƒë·ªông":"active","on":"active","maintenance":"maintenance","b·∫£o tr√¨":"maintenance","offline":"offline","off":"offline","inactive":"offline" };
    document.getElementById("atm_status").value    = STATUS_MAP[raw] || "active";
    document.getElementById("address").value       = a.address ?? "";
    document.getElementById("atm_image").value     = a.image ?? "";
    document.getElementById("atm_preview").src     = pickImage(a);
    document.getElementById("latitude").value      = a.latitude ?? "";
    document.getElementById("longitude").value     = a.longitude ?? "";
    document.getElementById("atm_created").value   = localTimeStr(a.created_ts, a.created_at||"");
    document.getElementById("atm_updated").value   = localTimeStr(a.updated_ts, a.updated_at||"");
  }

  /* ===== Marker icon =====
  * T·∫°o HTML cho icon c·ªßa c√°c lo·∫°i ƒëi·ªÉm (Ng√¢n h√†ng, Chi nh√°nh, ATM).
  */
  function iconHTML(type){
    const cls = type==="bank" ? "pin pin-bank" : type==="branch" ? "pin pin-branch" : "pin pin-atm";
    const emoji = type==="bank" ? "üè¶" : type==="branch" ? "üè¢" : "üèß";
    return `<div class="${cls}">${emoji}</div>`;
  }

  /*
  * T·∫°o bi·ªÉu t∆∞·ª£ng c·ªßa c√°c ƒëi·ªÉm (Ng√¢n h√†ng, Chi nh√°nh, ATM) b·∫±ng Leaflet divIcon.
  */
  function createDivIcon(type){
    return L.divIcon({ html: iconHTML(type), className:"", iconSize:[28,28], iconAnchor:[14,14], popupAnchor:[0,-16] });
  }
/*
* Th√™m c√°c s·ª± ki·ªán cho c√°c n√∫t trong popup (v√≠ d·ª•: xem ATM, chi nh√°nh, ch·ªâ ƒë∆∞·ªùng).
*/
  function onPopupButtonsReady(popupEl, type, d){
    popupEl.querySelector('[data-act="view-atm"]')?.addEventListener('click', (ev)=>{
      const bankId = ev.currentTarget.getAttribute('data-bank-id');
      resetUI({keepSearch:true});
      showATMsOfBank(bankId);
    });
    popupEl.querySelector('[data-act="view-branch"]')?.addEventListener('click', (ev)=>{
      const bankId = ev.currentTarget.getAttribute('data-bank-id');
      resetUI({keepSearch:true});
      showBranchesOfBank(bankId);
    });
    popupEl.querySelector('[data-act="route"]')?.addEventListener('click', async (ev)=>{
      const btn = ev.currentTarget;
      const dest = [parseFloat(btn.getAttribute('data-lat')), parseFloat(btn.getAttribute('data-lng'))];
      const start = await getStartPoint();
      clearRoute();
      routingControl.setWaypoints([ L.latLng(start[0], start[1]), L.latLng(dest[0], dest[1]) ]);
    });
  }
/*
* T·∫°o marker (ch·ªâ d·∫´n) tr√™n b·∫£n ƒë·ªì cho Ng√¢n h√†ng, Chi nh√°nh ho·∫∑c ATM.
*/
  function makeMarker(lat, lng, type, d){
    const m = L.marker([+lat,+lng], { icon:createDivIcon(type) }).addTo(map);
    const html = infoHTML(type, d);
    m.bindPopup(html, { autoPan: true, closeButton: true });
    m.on('popupopen', (e)=>{ const el = e.popup.getElement(); if(el) onPopupButtonsReady(el, type, d); });
    m.on('mouseover', ()=>{ if(hoverTimer){ clearTimeout(hoverTimer); hoverTimer=null; } m.openPopup(); });
    m.on('mouseout', ()=>{ hoverTimer = setTimeout(()=> m.closePopup(), 400); });
    m.on('click', ()=>{
      if(hoverTimer){ clearTimeout(hoverTimer); hoverTimer=null; }
      setDetail(type, d);
      if(isAdmin()){
        if(type==="bank")   fillBankForm(d);
        if(type==="branch") fillBranchForm(d);
        if(type==="atm")    fillATMForm(d);
      }
    });
    return m;
  }

  /* Search matching
  * Ki·ªÉm tra n·∫øu m·ªôt ng√¢n h√†ng,atm,chi nh√°nh ph√π h·ª£p v·ªõi vƒÉn b·∫£n t√¨m ki·∫øm.
  */
  function matchTextBank(b){ if(!qText) return true; const t=qText.toLowerCase(); return (b.code||"").toLowerCase().includes(t) || (b.name||"").toLowerCase().includes(t) || (b.address||"").toLowerCase().includes(t); }
  function matchTextBranch(br){ if(!qText) return true; const t=qText.toLowerCase(); return (br.code||"").toLowerCase().includes(t) || (br.name||"").toLowerCase().includes(t) || (br.address||"").toLowerCase().includes(t) || (br["bank__name"]||"").toLowerCase().includes(t); }
  function matchTextATM(a){ if(!qText) return true; const t=qText.toLowerCase(); return (a.code||"").toLowerCase().includes(t) || (a.address||"").toLowerCase().includes(t) || (a["branch__name"]||"").toLowerCase().includes(t) || (a["branch__bank__name"]||"").toLowerCase().includes(t); }

  /* V·∫Ω c√°c markers cho Ng√¢n h√†ng, Chi nh√°nh, ATM tr√™n b·∫£n ƒë·ªì.*/
  function drawBanks(){ bankMarkers.forEach(m=>m.remove()); bankMarkers=[]; if(!showBanks) return;
    BANKS.filter(matchTextBank).forEach(b=>{ if(b.latitude==null||b.longitude==null) return; bankMarkers.push(makeMarker(b.latitude,b.longitude,"bank",b)); });
  }
  function drawBranches(){ branchMarkers.forEach(m=>m.remove()); branchMarkers=[]; if(!showBranches) return;
    BRANCHES.filter(matchTextBranch).filter(br=> filterBankIdForBranches==null ? true : String(br.bank_id)===String(filterBankIdForBranches))
      .forEach(br=>{ if(br.latitude==null||br.longitude==null) return; branchMarkers.push(makeMarker(br.latitude,br.longitude,"branch",br)); });
  }
  function drawATMs(){ atmMarkers.forEach(m=>m.remove()); atmMarkers=[]; if(!showATMs) return;
    atms.filter(matchTextATM).filter(a=>{
      if (filterBankIdForATMs==null) return true;
      const bankIdFromATM = (a.branch__bank_id!=null) ? a.branch__bank_id : a.bank_id;
      return String(bankIdFromATM)===String(filterBankIdForATMs);
    }).forEach(a=>{ if(a.latitude==null||a.longitude==null) return; atmMarkers.push(makeMarker(a.latitude,a.longitude,"atm",a)); });
  }
  /* L√†m m·ªõi c√°c l·ªõp d·ªØ li·ªáu (Ng√¢n h√†ng, Chi nh√°nh, ATM) tr√™n b·∫£n ƒë·ªì.*/
  function refreshLayers(){ drawBanks(); drawBranches(); drawATMs(); }

  /* Search panel 
   Hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm tr√™n giao di·ªán.
  */
  function renderSearchResults(){
    const wrap=document.getElementById("results");
    if(!qText){ hideResults(); refreshLayers(); return; }
    const banks=BANKS.filter(matchTextBank);
    const branches=BRANCHES.filter(matchTextBranch);
    const atmsM=atms.filter(matchTextATM);
    refreshLayers();
    const sec=(title,items,fmt)=>`
      <div class="section">
        <button class="close" id="results-close">‚úñ</button>
        <h4>${title} <span class="pill">${items.length}</span></h4>
        <div class="list">${items.map(fmt).join("")}</div>
      </div>`;
    const fmtBank   = (b)=>`<div class="item" data-type="bank"   data-id="${b.id}">
      <div><b>${esc(b.code||"")}</b> ‚Äî ${esc(b.name||"")}</div>
      <div class="sub">${esc(b.address||"")}</div>
    </div>`;
    const fmtBranch = (br)=>`<div class="item" data-type="branch" data-id="${br.id}">
      <div><b>${esc(br.code||"")}</b> ‚Äî ${esc(br.name||"")}</div>
      <div class="sub">${esc(br["bank__name"]||"")} ¬∑ ${esc(br.address||"")}</div>
    </div>`;
    const fmtATM    = (a)=>`<div class="item" data-type="atm"    data-id="${a.id}">
      <div><b>${esc(a.code||"ATM")}</b> ‚Äî ${esc(a["branch__name"]||"")}</div>
      <div class="sub">${esc(a["branch__bank__name"]||"")} ¬∑ ${esc(a.address||"")}</div>
    </div>`;

    wrap.innerHTML = (banks.length?sec("Ng√¢n h√†ng",banks,fmtBank):"") + (branches.length?sec("Chi nh√°nh",branches,fmtBranch):"") + (atmsM.length?sec("ATM",atmsM,fmtATM):"");
    wrap.style.display="block";

    wrap.querySelector("#results-close")?.addEventListener("click", ()=>{ hideResults(); });

    wrap.querySelectorAll(".item").forEach(el=>{
      el.addEventListener("click", ()=>{
        const type=el.dataset.type, id=el.dataset.id;
        if(type==="bank"){
          const b=BANKS.find(x=>String(x.id)===id); if(b){ map.setView([+b.latitude,+b.longitude], 15); setDetail("bank", b); if(isAdmin()) fillBankForm(b); }
        } else if(type==="branch"){
          const br=BRANCHES.find(x=>String(x.id)===id); if(br){ map.setView([+br.latitude,+br.longitude], 15); setDetail("branch", br); if(isAdmin()) fillBranchForm(br); }
        } else {
          const a=atms.find(x=>String(x.id)===id); if(a){ map.setView([+a.latitude,+a.longitude], 15); setDetail("atm", a); if(isAdmin()) fillATMForm(a); }
        }
      });
    });
  }

  /* ·∫®n c√°c k·∫øt qu·∫£ t√¨m ki·∫øm.*/
  function hideResults(){ const wrap=document.getElementById("results"); wrap.style.display="none"; wrap.innerHTML=""; }

  /* Di chuy·ªÉn b·∫£n ƒë·ªì ƒë·∫øn v·ªã tr√≠ c·ªßa m·ªôt ƒëi·ªÉm d·ªØ li·ªáu c·ª• th·ªÉ (Ng√¢n h√†ng, Chi nh√°nh, ATM).*/
  function panToData(type,d){
    if(d.latitude==null||d.longitude==null) return;
    map.setView([+d.latitude,+d.longitude], 15);
  }

  /* My location & routing
  * K√≠ch ho·∫°t v√† l·∫•y v·ªã tr√≠ c·ªßa ng∆∞·ªùi d√πng.
  */
  function enableMyLocation(){
    if(!navigator.geolocation){ alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation."); return; }
    showLottie("scan","ƒêang l·∫•y v·ªã tr√≠ c·ªßa b·∫°n‚Ä¶");
    navigator.geolocation.getCurrentPosition(pos=>{
      setMyPos(pos.coords.latitude, pos.coords.longitude, true);
      if(!geoWatchId){
        geoWatchId=navigator.geolocation.watchPosition(p=>{ setMyPos(p.coords.latitude,p.coords.longitude,false); });
      }
      hideLottie(200);
    }, err=>{
      hideLottie(0);
      alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠: "+err.message);
    }, {enableHighAccuracy:true,timeout:10000,maximumAge:10000});
  }

  /* Thi·∫øt l·∫≠p v·ªã tr√≠ c·ªßa ng∆∞·ªùi d√πng v√† di chuy·ªÉn b·∫£n ƒë·ªì ƒë·∫øn v·ªã tr√≠ ƒë√≥.*/
  function setMyPos(lat,lng,pan){
    myPos = [lat, lng];
    if(!meMarker){ meMarker = L.marker(myPos).addTo(map); }
    else meMarker.setLatLng(myPos);
    if(pan) map.setView(myPos, 14);
  }
  /* L·∫•y v·ªã tr√≠ hi·ªán t·∫°i c·ªßa ng∆∞·ªùi d√πng ho·∫∑c v·ªã tr√≠ m·∫∑c ƒë·ªãnh.*/
  async function getStartPoint(){
    if(myPos) return myPos;
    return new Promise(resolve=>{
      if(!navigator.geolocation){ const c=map.getCenter(); return resolve([c.lat, c.lng]); }
      navigator.geolocation.getCurrentPosition(p=>{
        const s=[p.coords.latitude,p.coords.longitude]; setMyPos(...s, false); resolve(s);
      }, _=>{ const c=map.getCenter(); resolve([c.lat, c.lng]); }, {enableHighAccuracy:true, timeout:5000});
    });
  }
  /* X√≥a l·ªô tr√¨nh (route) ƒë√£ ƒë∆∞·ª£c v·∫Ω tr√™n b·∫£n ƒë·ªì.*/
  function clearRoute(){
    if(routingControl){ routingControl.setWaypoints([]); }
  }

  /* Nearest tinh khoang cach gan nhat
  * T√≠nh kho·∫£ng c√°ch gi·ªØa hai ƒëi·ªÉm (theo vƒ© ƒë·ªô v√† kinh ƒë·ªô) b·∫±ng c√¥ng th·ª©c haversine.
  */
  function hav(a,b){ const R=6371008.8, toRad=x=>x*Math.PI/180; const dlat=toRad(b[0]-a[0]), dlng=toRad(b[1]-a[1]); const s=Math.sin(dlat/2)**2+Math.cos(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.sin(dlng/2)**2; return 2*R*Math.asin(Math.sqrt(s)); }
  /** S·∫Øp x·∫øp danh s√°ch c√°c ƒëi·ªÉm theo kho·∫£ng c√°ch g·∫ßn nh·∫•t v·ªõi v·ªã tr√≠ c·ªßa ng∆∞·ªùi d√πng.*/
  function nearestList(list){
    if(!myPos){ alert("H√£y b·∫≠t 'V·ªã tr√≠ c·ªßa t√¥i' tr∆∞·ªõc."); return []; }
    const res=[];
    list.forEach(d=>{
      if(d.latitude==null||d.longitude==null) return;
      const dist=hav(myPos,[+d.latitude,+d.longitude]); res.push({d, dist});
    });
    res.sort((a,b)=>a.dist-b.dist);
    return res;
  }
  /*Hi·ªÉn th·ªã ƒëi·ªÉm g·∫ßn nh·∫•t (Ng√¢n h√†ng, Chi nh√°nh, ATM) v·ªõi ng∆∞·ªùi d√πng.*/
  function showNearest(type){
    resetUI({keepSearch:true});
    showLottie("scan","ƒêang t√¨m ƒëi·ªÉm g·∫ßn nh·∫•t‚Ä¶");
    let rows=[];
    if(type==="bank") rows=nearestList(BANKS);
    else if(type==="branch") rows=nearestList(BRANCHES);
    else rows=nearestList(atms);

    const wrap=document.getElementById("results");
    const title = type==="bank"?"Ng√¢n h√†ng g·∫ßn nh·∫•t": type==="branch"?"Chi nh√°nh g·∫ßn nh·∫•t":"ATM g·∫ßn nh·∫•t";
    const fmt=(o)=> type==="bank"
      ? `<div class="item" data-type="bank" data-id="${o.d.id}">
           <div><b>${esc(o.d.code||"")}</b> ‚Äî ${esc(o.d.name||"")} <span class="dist">${(o.dist/1000).toFixed(2)} km</span></div>
           <div class="sub">${esc(o.d.address||"")}</div></div>`
      : type==="branch"
      ? `<div class="item" data-type="branch" data-id="${o.d.id}">
           <div><b>${esc(o.d.code||"")}</b> ‚Äî ${esc(o.d.name||"")} <span class="dist">${(o.dist/1000).toFixed(2)} km</span></div>
           <div class="sub">${esc(o.d["bank__name"]||"")} ¬∑ ${esc(o.d.address||"")}</div></div>`
      : `<div class="item" data-type="atm" data-id="${o.d.id}">
           <div><b>${esc(o.d.code||"ATM")}</b> ‚Äî ${esc(o.d["branch__name"]||"")} <span class="dist">${(o.dist/1000).toFixed(2)} km</span></div>
           <div class="sub">${esc(o.d["branch__bank__name"]||"")} ¬∑ ${esc(o.d.address||"")}</div></div>`;

    wrap.innerHTML = `<div class="section"><button class="close" id="results-close">‚úñ</button><h4>${title} <span class="pill">${rows.length}</span></h4><div class="list">${rows.map(fmt).join("")}</div></div>`;
    wrap.style.display="block";
    hideLottie(200);
    document.getElementById("results-close")?.addEventListener("click", hideResults);

    wrap.querySelectorAll(".item").forEach(el=>{
      el.addEventListener("click", ()=>{
        const type=el.dataset.type, id=el.dataset.id;
        if(type==="bank"){ const b=BANKS.find(x=>String(x.id)===id); if(b){ panToData("bank", b); if(isAdmin()) fillBankForm(b); } }
        else if(type==="branch"){ const br=BRANCHES.find(x=>String(x.id)===id); if(br){ panToData("branch", br); if(isAdmin()) fillBranchForm(br); } }
        else { const a=atms.find(x=>String(x.id)===id); if(a){ panToData("atm", a); if(isAdmin()) fillATMForm(a); } }
      });
    });
  }

  /* Stats modal
  * M·ªü modal hi·ªÉn th·ªã th·ªëng k√™ d·ªØ li·ªáu (Ng√¢n h√†ng, Chi nh√°nh, ATM).
  */
  const statsModal=document.getElementById("stats-modal");
  function openStats(){
    const tb=document.querySelector("#tbl-banks tbody"); if(tb){ tb.innerHTML="";
      BANKS.forEach(b=>{
        const tr=document.createElement("tr");
        tr.dataset.type="bank"; tr.dataset.id=b.id;
        tr.innerHTML=`<td>${esc(b.code||"")}</td><td>${esc(b.name||"")}</td><td>${countBranchesOfBank(b.id)}</td><td>${countATMsOfBank(b.id)}</td><td>${esc(b.address||"")}</td>`;
        tb.appendChild(tr);
      });
    }
    const tbr=document.querySelector("#tbl-branches tbody"); if(tbr){ tbr.innerHTML="";
      BRANCHES.forEach(br=>{
        const tr=document.createElement("tr");
        tr.dataset.type="branch"; tr.dataset.id=br.id;
        tr.innerHTML=`<td>${esc(br["bank__name"]||"")}</td><td>${esc(br.code||"")}</td><td>${esc(br.name||"")}</td><td>${countATMsOfBranch(br.id)}</td><td>${esc(br.address||"")}</td>`;
        tbr.appendChild(tr);
      });
    }
    const ta=document.querySelector("#tbl-atms tbody"); if(ta){ ta.innerHTML="";
      atms.forEach(a=>{
        const tr=document.createElement("tr");
        tr.dataset.type="atm"; tr.dataset.id=a.id;
        tr.innerHTML=`<td>${esc(a.code||"ATM")}</td><td>${esc(a["branch__bank__name"]||"")}</td><td>${esc(a["branch__name"]||"")}</td><td>${esc(a.status||"")}</td><td>${esc(a.address||"")}</td>`;
        ta.appendChild(tr);
      });
    }
    statsModal.style.display="grid";
  }
  /** ƒê√≥ng modal hi·ªÉn th·ªã th·ªëng k√™ d·ªØ li·ªáu.*/
  function closeStats(){ statsModal.style.display="none"; }
  document.getElementById("stats-close")?.addEventListener("click", closeStats);
  statsModal?.addEventListener("click", (e)=>{ if(e.target===statsModal) closeStats(); });
  document.querySelectorAll(".tabs2 .btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tabs2 .btn").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      document.querySelectorAll(".table-wrap .panel").forEach(x=>x.classList.remove("active"));
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });

  document.querySelectorAll(".table-wrap").forEach(wrap=>{
    wrap.addEventListener("click",(e)=>{
      const tr=e.target.closest("tr"); if(!tr) return;
      const type=tr.dataset.type, id=tr.dataset.id;
      if(type==="bank"){ const b=BANKS.find(x=>String(x.id)===id); if(b) { closeStats(); panToData("bank", b); if(isAdmin()) fillBankForm(b); } }
      else if(type==="branch"){ const br=BRANCHES.find(x=>String(x.id)===id); if(br) { closeStats(); panToData("branch", br); if(isAdmin()) fillBranchForm(br); } }
      else { const a=atms.find(x=>String(x.id)===id); if(a) { closeStats(); panToData("atm", a); if(isAdmin()) fillATMForm(a); } }
    });
  });

  /* POST forms 
  * G·ª≠i d·ªØ li·ªáu t·ª´ form l√™n server (POST).
  */
  function postForm(url, fd){
    return fetch(url, {
      method: "POST", credentials: "same-origin",
      headers: { "X-CSRFToken": getCSRFToken(), "X-Requested-With": "XMLHttpRequest" },
      body: fd
    }).then(r => r.ok ? r : r.text().then(Promise.reject));
  }
  /** Li√™n k·∫øt form "Ng√¢n h√†ng" v·ªõi c√°c s·ª± ki·ªán (submit, xo√°, reset).*/
  function bindBankForm(){
    const f=document.getElementById("form-save-bank");
    f.addEventListener("submit",(ev)=>{ ev.preventDefault(); const fd=new FormData(f); postForm("{% url 'bank_save' %}", fd).then(()=>location.reload()).catch(e=>alert("L·ªói Bank: "+e)); });
    document.getElementById("btn-delete-bank").addEventListener("click", ()=>{
      const id=(document.getElementById('bank_id').value||"").trim(); if(!id) return alert("Ch∆∞a ch·ªçn ng√¢n h√†ng ƒë·ªÉ xo√°.");
      if(!confirm("Xo√° ng√¢n h√†ng n√†y?")) return;
      const fd=new FormData(); fd.append("bank_id", id);
      postForm("{% url 'bank_delete' %}", fd).then(()=>location.reload()).catch(e=>alert("L·ªói xo√° Bank: "+e));
    });
  }
  /*
  * Li√™n k·∫øt form "Chi nh√°nh" v·ªõi c√°c s·ª± ki·ªán (submit, xo√°, reset).
  */
  function bindBranchForm(){
    const f=document.getElementById("form-save-branch");
    f.addEventListener("submit",(ev)=>{ ev.preventDefault(); const fd=new FormData(f); postForm("{% url 'branch_save' %}", fd).then(()=>location.reload()).catch(e=>alert("L·ªói Branch: "+e)); });
    document.getElementById("btn-delete-branch").addEventListener("click", ()=>{
      const id=(document.getElementById('branch_id').value||"").trim(); if(!id) return alert("Ch∆∞a ch·ªçn chi nh√°nh ƒë·ªÉ xo√°.");
      if(!confirm("Xo√° chi nh√°nh n√†y? (C√≥ th·ªÉ xo√° ATM li√™n quan)")) return;
      const fd=new FormData(); fd.append("branch_id", id);
      postForm("{% url 'branch_delete' %}", fd).then(()=>location.reload()).catch(e=>alert("L·ªói xo√° Branch: "+e));
    });
  }
  /*
  * Li√™n k·∫øt form "ATM" v·ªõi c√°c s·ª± ki·ªán (submit, xo√°, reset).
  */
  function bindATMForm(){
    const f=document.getElementById("form-save-atm");
    f.addEventListener("submit",(ev)=>{ ev.preventDefault(); const fd=new FormData(f); if(!fd.get("branch")) return alert("Ch·ªçn chi nh√°nh tr∆∞·ªõc khi l∆∞u ATM."); postForm("{% url 'atm_save' %}", fd).then(()=>location.reload()).catch(e=>alert("L·ªói ATM: "+e)); });
    document.getElementById("btn-delete-atm").addEventListener("click", ()=>{
      const id=(document.getElementById('atm_id').value||"").trim(); if(!id) return alert("Ch∆∞a ch·ªçn ATM ƒë·ªÉ xo√°.");
      if(!confirm("Xo√° ATM n√†y?")) return;
      const fd=new FormData(); fd.append("atm_id", id);
      postForm("{% url 'atm_delete' %}", fd).then(()=>location.reload()).catch(e=>alert("L·ªói xo√° ATM: "+e));
    });
  }

  /* Reset helpers
  * X√≥a c√°c gi√° tr·ªã trong c√°c tr∆∞·ªùng form.
  * X√≥a ·∫£nh preview trong form.
  *  Reset form "Ng√¢n h√†ng" v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu.
  *  Reset form "Chi nh√°nh" v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu.
  *  Reset form "ATM" v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu.
  */
  function clear(ids){ ids.forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.tagName==="SELECT"){} else el.value=""; }); }
  function resetImg(id){ const img=document.getElementById(id); if(img) img.src=""; if(clickMarker){ clickMarker.remove(); clickMarker=null; } }
  function resetBankForm(){ clear(["bank_id","bank_code","bank_name","bank_address","bank_phone","bank_image","bank_latitude","bank_longitude","bank_created","bank_updated"]); resetImg("bank_preview"); }
  function resetBranchForm(){ const keep=document.getElementById("branch_bank")?.value; clear(["branch_id","branch_code","branch_name","branch_address","branch_phone","branch_image","branch_latitude","branch_longitude","branch_created","branch_updated"]); if(document.getElementById("branch_bank")) document.getElementById("branch_bank").value=keep; resetImg("branch_preview"); }
  function resetATMForm(){ const keep=document.getElementById("branch")?.value; clear(["atm_id","code","address","atm_image","latitude","longitude","atm_created","atm_updated"]); if(document.getElementById("branch")) document.getElementById("branch").value=keep; document.getElementById("atm_status").value="active"; resetImg("atm_preview"); }

  /* L·ªçc ATM theo Ng√¢n h√†ng.*/
  function setATMFilterByBank(bankId){
    const id = bankId != null ? Number(bankId) : null;
    filterBankIdForATMs = isNaN(id) ? bankId : id;
    showATMs = true; document.getElementById("show-atms")?.classList.add("active");
    refreshLayers();
  }
  /*L·ªçc Chi nh√°nh theo Ng√¢n h√†ng.*/
  function setBranchFilterByBank(bankId){
    const id = bankId != null ? Number(bankId) : null;
    filterBankIdForBranches = isNaN(id) ? bankId : id;
    showBranches = true; document.getElementById("show-branches")?.classList.add("active");
    refreshLayers();
  }
  /* X√≥a b·ªô l·ªçc ng√¢n h√†ng cho ATM v√† Chi nh√°nh.*/
  function clearBankFilters(){ filterBankIdForATMs = null; filterBankIdForBranches = null; }

  /*
  * Reset l·∫°i giao di·ªán ng∆∞·ªùi d√πng (c√°c b·ªô l·ªçc, t√¨m ki·∫øm, l·ªõp d·ªØ li·ªáu).
  */
  function resetUI(opts={}){
    clearBankFilters();
    showBanks=true; showBranches=true; showATMs=true;
    document.getElementById("show-banks")?.classList.add("active");
    document.getElementById("show-branches")?.classList.add("active");
    document.getElementById("show-atms")?.classList.add("active");
    clearRoute();
    hideResults();
    if(!opts.keepSearch){ const q=document.getElementById("q"); if(q){ q.value=""; qText=""; } }
    refreshLayers();
  }

  /* Xem ATM/Branch theo bank
  * Hi·ªÉn th·ªã t·∫•t c·∫£ c√°c ATM c·ªßa m·ªôt ng√¢n h√†ng c·ª• th·ªÉ.
  */
  function showATMsOfBank(bankId) {
    hideResults();
    setATMFilterByBank(bankId);
    const bank = BANKS.find(b => String(b.id) === String(bankId));
    const relatedATMs = atms.filter(a => String((a.branch__bank_id!=null)?a.branch__bank_id:a.bank_id) === String(bankId));

    const wrap = document.getElementById("results");
    if (wrap) {
      const fmtATM = (a)=>`<div class="item" data-type="atm" data-id="${a.id}">
        <div><b>${esc(a.code||"ATM")}</b> ‚Äî ${esc(a["branch__name"]||"")}</div>
        <div class="sub">${esc(a["branch__bank__name"]||bank?.name||"")} ¬∑ ${esc(a.address||"")}</div>
      </div>`;
      wrap.innerHTML = `<div class="section"><button class="close" id="results-close">‚úñ</button><h4>ATM c·ªßa ${esc(bank?.code||"")} - ${esc(bank?.name||"")} <span class="pill">${relatedATMs.length}</span></h4><div class="list">${relatedATMs.map(fmtATM).join("") || "<div class='item'>Ch∆∞a c√≥ ATM.</div>"}</div></div>`;
      wrap.style.display = "block";
      document.getElementById("results-close")?.addEventListener("click", hideResults);
      wrap.querySelectorAll(".item[data-type='atm']").forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.dataset.id;
          const a = atms.find(x => String(x.id) === String(id));
          if(a){ panToData("atm", a); if(isAdmin()) fillATMForm(a); }
        });
      });
    }

    if (relatedATMs.length){
      const g = L.featureGroup(relatedATMs.filter(a=>a.latitude!=null&&a.longitude!=null).map(a=>L.marker([+a.latitude,+a.longitude])));
      if (g.getLayers().length) map.fitBounds(g.getBounds().pad(0.15));
    }
  }
  /*
  * Hi·ªÉn th·ªã t·∫•t c·∫£ c√°c Chi nh√°nh c·ªßa m·ªôt ng√¢n h√†ng c·ª• th·ªÉ.
  */
  function showBranchesOfBank(bankId) {
    hideResults();
    setBranchFilterByBank(bankId);
    const relatedBranches = BRANCHES.filter(br => String(br.bank_id) === String(bankId));
    const bank = BANKS.find(b => String(b.id) === String(bankId));

    const wrap = document.getElementById("results");
    if (wrap) {
      const fmt = (br)=>`<div class="item" data-type="branch" data-id="${br.id}">
        <div><b>${esc(br.code||"")}</b> ‚Äî ${esc(br.name||"")}</div>
        <div class="sub">${esc(br["bank__name"]||bank?.name||"")} ¬∑ ${esc(br.address||"")}</div>
      </div>`;
      wrap.innerHTML = `<div class="section"><button class="close" id="results-close">‚úñ</button><h4>Chi nh√°nh c·ªßa ${esc(bank?.code||"")} - ${esc(bank?.name||"")} <span class="pill">${relatedBranches.length}</span></h4><div class="list">${relatedBranches.map(fmt).join("") || "<div class='item'>Ch∆∞a c√≥ chi nh√°nh.</div>"}</div></div>`;
      wrap.style.display = "block";
      document.getElementById("results-close")?.addEventListener("click", hideResults);
      wrap.querySelectorAll(".item[data-type='branch']").forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.dataset.id;
          const br = BRANCHES.find(x => String(x.id) === String(id));
          if(br){ panToData("branch", br); if(isAdmin()) fillBranchForm(br); }
        });
      });
    }

    if (relatedBranches.length){
      const g = L.featureGroup(relatedBranches.filter(b=>b.latitude!=null&&b.longitude!=null).map(b=>L.marker([+b.latitude,+b.longitude])));
      if (g.getLayers().length) map.fitBounds(g.getBounds().pad(0.15));
    }
  }

  /* Lottie */
  const LOTTIE_URLS = {
    scan: "https://assets10.lottiefiles.com/packages/lf20_4kx2q32n.json",
    success: "https://assets10.lottiefiles.com/packages/lf20_jbrw3hcz.json"
  };
  let lottiePlayer = null;
  function showLottie(kind="scan", text="ƒêang x·ª≠ l√Ω‚Ä¶", loop=true){
    const overlay = document.getElementById("lottie-overlay");
    const box = document.getElementById("lottie-box");
    const hint = overlay.querySelector(".hint");
    hint.textContent = text;
    overlay.classList.add("show");
    if (lottiePlayer){ lottiePlayer.destroy(); lottiePlayer=null; }
    lottiePlayer = lottie.loadAnimation({ container: box, renderer: "svg", loop, autoplay: true, path: LOTTIE_URLS[kind] || LOTTIE_URLS.scan });
  }
  function hideLottie(delayMs=0){
    const overlay = document.getElementById("lottie-overlay");
    const doHide = ()=>{ if (lottiePlayer){ lottiePlayer.destroy(); lottiePlayer=null; } overlay.classList.remove("show"); };
    delayMs ? setTimeout(doHide, delayMs) : doHide();
  }

  /* PRO MODE */
  const MODE_KEY = "ui-mode";
  function isProMode(){ return document.documentElement.getAttribute("data-mode")==="pro"; }
  function updateProBtn(){
    const btn = document.getElementById("btn-pro-mode");
    if(!btn) return;
    btn.textContent = isProMode() ? "‚Ü©Ô∏é Tho√°t Pro" : "‚ö° Ch·∫ø ƒë·ªô Pro";
  }
  /** √Åp d·ª•ng ch·∫ø ƒë·ªô giao di·ªán (ch·∫ø ƒë·ªô th∆∞·ªùng ho·∫∑c ch·∫ø ƒë·ªô Pro).*/
  function applyMode(mode){
    document.documentElement.setAttribute("data-mode", mode);
    localStorage.setItem(MODE_KEY, mode);
    if (map){
      if(mode==="pro"){ if (map.hasLayer(baseLight)) map.removeLayer(baseLight); baseDark.addTo(map); }
      else { if (map.hasLayer(baseDark)) map.removeLayer(baseDark); baseLight.addTo(map); }
    }
    /* C·∫≠p nh·∫≠t tr·∫°ng th√°i c·ªßa n√∫t "Ch·∫ø ƒë·ªô Pro".*/
    updateProBtn();
    updateCarPath();
  }

  /*
  * Chuy·ªÉn ƒë·ªïi gi·ªØa ch·∫ø ƒë·ªô th∆∞·ªùng v√† ch·∫ø ƒë·ªô Pro.*/
  function togglePro(){
    const next = isProMode() ? "normal" : "pro";
    showLottie("scan", isProMode() ? "ƒêang quay v·ªÅ giao di·ªán th∆∞·ªùng‚Ä¶" : "ƒêang chuy·ªÉn sang giao di·ªán Pro‚Ä¶");
    setTimeout(()=>{ applyMode(next); hideLottie(350); }, 500);
  }

  /* Xe ch·∫°y */
  function updateCarPath(){
    const box = document.getElementById("map");
    const car = document.getElementById("map-car");
    if(!box || !car) return;
    const CAR = 26;
    const PAD  = isProMode() ? -12 : 10;
    const w = Math.max(0, box.clientWidth  - (PAD*2 + CAR));
    const h = Math.max(0, box.clientHeight - (PAD*2 + CAR));
    car.style.setProperty("--w", w + "px");
    car.style.setProperty("--h", h + "px");
    car.style.setProperty("--pad", PAD + "px");
  }
  window.addEventListener("resize", updateCarPath);
  applyMode(localStorage.getItem(MODE_KEY) || "normal");

  /* INIT
  * Kh·ªüi t·∫°o b·∫£n ƒë·ªì v√† c√°c l·ªõp d·ªØ li·ªáu ban ƒë·∫ßu (Ng√¢n h√†ng, Chi nh√°nh, ATM).
  */
  function initMap(){
    map = L.map('map', { zoomControl: true }).setView([21.0285,105.8542], 12);
    baseLight = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' });
    baseDark  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap, &copy; CartoDB' });
    (isProMode() ? baseDark : baseLight).addTo(map);

    routingControl = L.Routing.control({
      waypoints:[], addWaypoints:false, draggableWaypoints:false, routeWhileDragging:false, showAlternatives:false, createMarker:()=>null
    }).addTo(map);
    if (routingControl && routingControl._container) routingControl._container.style.display = 'none';

    updateCarPath();

    if (document.getElementById("branch_bank")) fillBanks("branch_bank");
    if (document.getElementById("branch")) fillBranches("branch");
    if (document.getElementById("bank_image")) bindPreview("bank_image","bank_preview");
    if (document.getElementById("branch_image")) bindPreview("branch_image","branch_preview");
    if (document.getElementById("atm_image")) bindPreview("atm_image","atm_preview");

    map.on('click', (e)=>{
      if (clickMarker) clickMarker.remove();
      clickMarker = L.circleMarker(e.latlng, {radius:5, fillOpacity:1, weight:1, color:"#111827", fillColor:"#111827"}).addTo(map);

      const hasBankForm = !!document.getElementById("form-save-bank");
      const hasBranchForm = !!document.getElementById("form-save-branch");
      const hasATMForm = !!document.getElementById("form-save-atm");
      if (!hasBankForm && !hasBranchForm && !hasATMForm) return;

      const active = document.querySelector(".panel.active")?.id || "panel-bank";
      if (active==="panel-bank" && hasBankForm){
        resetBankForm();
        document.getElementById("bank_latitude").value=e.latlng.lat;
        document.getElementById("bank_longitude").value=e.latlng.lng;
      } else if (active==="panel-branch" && hasBranchForm){
        resetBranchForm();
        document.getElementById("branch_latitude").value=e.latlng.lat;
        document.getElementById("branch_longitude").value=e.latlng.lng;
      } else if (hasATMForm){
        resetATMForm();
        document.getElementById("latitude").value=e.latlng.lat;
        document.getElementById("longitude").value=e.latlng.lng;
        document.getElementById("atm_status").value="active";
      }
    });

    // Toolbar events
    const qEl = document.getElementById("q");
    qEl.addEventListener("input", debounce((e)=>{ qText=e.target.value.trim(); renderSearchResults(); },120));
    qEl.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        const t=qText.trim().toLowerCase(); if(!t) return;
        const cand = (BANKS.find(b=>matchTextBank(b)) || BRANCHES.find(b=>matchTextBranch(b)) || atms.find(a=>matchTextATM(a)));
        if(cand && cand.latitude!=null && cand.longitude!=null){ map.setView([+cand.latitude,+cand.longitude],15); }
      }
    });

    document.getElementById("show-banks").addEventListener("click", (e)=>{ showBanks=!showBanks; e.target.classList.toggle("active", showBanks); refreshLayers(); });
    document.getElementById("show-branches").addEventListener("click", (e)=>{ showBranches=!showBranches; e.target.classList.toggle("active", showBranches); refreshLayers(); });
    document.getElementById("show-atms").addEventListener("click", (e)=>{ showATMs=!showATMs; e.target.classList.toggle("active", showATMs); refreshLayers(); });
    document.getElementById("btn-my-location").addEventListener("click", enableMyLocation);
    document.getElementById("btn-nearest-atm").addEventListener("click", ()=>showNearest("atm"));
    document.getElementById("btn-nearest-branch").addEventListener("click", ()=>showNearest("branch"));
    document.getElementById("btn-nearest-bank").addEventListener("click", ()=>showNearest("bank"));
    document.getElementById("btn-reset-ui").addEventListener("click", ()=>resetUI());

    const _btnStats = document.getElementById("btn-stats"); if (_btnStats) _btnStats.addEventListener("click", openStats);
    const _btnPermissions = document.getElementById("btn-permissions");
    if (_btnPermissions) { _btnPermissions.addEventListener("click", () => { window.location.href = "{% url 'manage_permissions' %}"; }); }

    document.getElementById("btn-pro-mode")?.addEventListener("click", togglePro);
    updateProBtn();

    if (document.getElementById("form-save-bank")) bindBankForm();
    if (document.getElementById("form-save-branch")) bindBranchForm();
    if (document.getElementById("form-save-atm")) bindATMForm();

    document.getElementById("btn-reset-bank")?.addEventListener("click", resetBankForm);
    document.getElementById("btn-reset-branch")?.addEventListener("click", resetBranchForm);
    document.getElementById("btn-reset-atm")?.addEventListener("click", resetATMForm);

    // v·∫Ω data l·∫ßn ƒë·∫ßu
    refreshLayers();
  }

  /* Utils */
  function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); }; }

  /* Start */
  window.initMap = initMap;
  if (document.readyState !== 'loading') initMap();
  else window.addEventListener('DOMContentLoaded', initMap);

  // Toggle form visibility
  document.getElementById('toggle-bank-form')?.addEventListener('click', function() {
    const formBody = document.querySelector('#panel-bank .body'); const btn = document.getElementById('toggle-bank-form');
    if (!formBody || !btn) return; if (formBody.style.display === 'none') { formBody.style.display = 'block'; btn.textContent = '‚è∫'; } else { formBody.style.display = 'none'; btn.textContent = '‚ñ∂Ô∏è'; }
  });
  document.getElementById('toggle-branch-form')?.addEventListener('click', function() {
    const formBody = document.querySelector('#panel-branch .body'); const btn = document.getElementById('toggle-branch-form');
    if (!formBody || !btn) return; if (formBody.style.display === 'none') { formBody.style.display = 'block'; btn.textContent = '‚è∫'; } else { formBody.style.display = 'none'; btn.textContent = '‚ñ∂Ô∏è'; }
  });
  document.getElementById('toggle-atm-form')?.addEventListener('click', function() {
    const formBody = document.querySelector('#panel-atm .body'); const btn = document.getElementById('toggle-atm-form');
    if (!formBody || !btn) return; if (formBody.style.display === 'none') { formBody.style.display = 'block'; btn.textContent = '‚è∫'; } else { formBody.style.display = 'none'; btn.textContent = '‚ñ∂Ô∏è'; }
  });

  document.getElementById('btn-logout')?.addEventListener('click', (e)=>{ if(!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) e.preventDefault(); });

  </script>
</body>
</html>
